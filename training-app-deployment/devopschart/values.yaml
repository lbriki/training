namespaces:
  - name: training-app-frontend-prod
  - name: training-app-backend-prod

deployment:
  - app: backend
    namespace: training-app-backend-prod
    replicas: 1
    containers:
      - repository: housseinhmila/t-007-backend:v1.0.0
        name: backend
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
        port: 3000
        env:
          - name: APP_PORT
            secretName: backend-secret
            secretKey: APP_PORT
          - name: QR_URL
            secretName: backend-secret
            secretKey: QR_URL
          - name: MONGO_URI
            secretName: backend-secret
            secretKey: MONGO_URI
          - name: MONGO_DB
            secretName: backend-secret
            secretKey: MONGO_DB
      - repository: housseinhmila/t-007-qr:v2.0.0
        name: qr
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
        port: 8420
        env:
          - name: QR_TMP_FOLDER
            secretName: qr-secret
            secretKey: QR_TMP_FOLDER
          - name: QR_FILL_COLOR
            secretName: qr-secret
            secretKey: QR_FILL_COLOR
          - name: QR_BACKGROUND_COLOR
            secretName: qr-secret
            secretKey: QR_BACKGROUND_COLOR
          - name: USE_BUCKET
            secretName: qr-secret
            secretKey: USE_BUCKET
          - name: BUCKET_ENDPOINT
            secretName: qr-secret
            secretKey: BUCKET_ENDPOINT
          - name: BUCKET_NAME
            secretName: qr-secret
            secretKey: BUCKET_NAME
          - name: BUCKET_ACCESS_KEY
            secretName: qr-secret
            secretKey: BUCKET_ACCESS_KEY
          - name: BUCKET_SECRET_KEY
            secretName: qr-secret
            secretKey: BUCKET_SECRET_KEY
  - app: website
    namespace: training-app-frontend-prod
    replicas: 1
    containers:
      - repository: housseinhmila/t-007-website:v1.0.0
        name: website
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
        port: 4200
    volumeMounts:    
      - name: config-volume
        mountPath: /etc/nginx/html/assets/configs
    volumes:
      - name: config-volume
        configMap:
          name: website-configmap
    configmap:
      - name: website-configmap
        namespace: training-app-frontend-prod
        files: 
          - filename: "app-config.json"
            path: "configs"

secret:
  - name: backend-secret
    namespace: training-app-backend-prod
    data: 
      APP_PORT: "MzAwMA=="
      QR_URL: "aHR0cDovL2xvY2FsaG9zdDo4NDIwLw=="
      MONGO_URI: "bW9uZ29kYitzcnY6Ly9ob3Vzc2VpbjprYWlyb3VhbkBjbHVzdGVyMC4wdGMxMmllLm1vbmdvZGIubmV0"
      MONGO_DB: "dGVzdA=="
  - name: qr-secret
    namespace: training-app-backend-prod
    data: 
      QR_TMP_FOLDER: "Li9nZW5lcmF0ZWRfcXI="
      QR_FILL_COLOR: "IzEyMTEyOA=="
      QR_BACKGROUND_COLOR: "I2RjZGJkYg=="
      USE_BUCKET: "dHJ1ZQ=="
      BUCKET_ENDPOINT: "cGxheS5taW4uaW86OTAwMA=="
      BUCKET_ACCESS_KEY: "UTNBTTNVUTg2N1NQUVFBNDNQMkY="
      BUCKET_SECRET_KEY: "enVmK3RmdGVTbHN3UnU3Qko4Nndla2l0bmlmSUxiWmFtMUtZWTNURw=="
      BUCKET_NAME: "dGVzdDEyMw=="
      BUCKET_PATH: ""
      BUCKET_ENDPOINT_WEB: "aHR0cDovL3BsYXkubWluLmlvOjkwMDA="

service:
  - name: website-service
    namespace: training-app-frontend-prod
    port: 80
    protocol: TCP
    targetPort: 4200
    type: NodePort
    app: website
  - name: backend-service
    namespace: training-app-backend-prod
    port: 8080
    protocol: TCP
    targetPort: 3000
    type: NodePort
    app: backend

ingress:
  - name: backend-ingress
    namespace: training-app-backend-prod
    annotations:
      nginx.ingress.kubernetes.io/use-regex: "true"
      nginx.ingress.kubernetes.io/rewrite-target: /$2
    host: localhost
    path: /api(/|$)(.*)
    pathType: Prefix
    ingressClassName: nginx
    service: backend-service
    port: 8080
  - name: website-ingress
    namespace: training-app-frontend-prod
    host: localhost
    path: /
    pathType: Prefix
    service: website-service
    port: 80
    ingressClassName: nginx
